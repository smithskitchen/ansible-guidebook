<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ansible Project: Compliance & Patch Management (AWX/Tower)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: #fcfcfd;
            color: #222;
            margin: 0;
            padding: 0 0 55px 0;
        }
        header, footer {
            text-align: center;
            background: #234e70;
            color: #fff;
            padding: 1em 0;
        }
        main {
            max-width: 1100px;
            margin: 30px auto;
            background: #fff;
            padding: 2.7em 2em;
            border-radius: 10px;
            box-shadow: 0 2px 12px 0 rgba(64,64,64,0.09);
        }
        h1, h2, h3, h4 {
            color: #234e70;
        }
        h1 {
            border-bottom: 2px solid #f5f5f5;
            padding-bottom: 0.3em;
            font-size: 2em;
        }
        h2 {
            margin-top: 2em;
            font-size: 1.2em;
            border-left: 4px solid #234e70;
            padding-left: 10px;
        }
        h3 {
            margin-top: 1.3em;
            font-size: 1.08em;
            color: #3d6ba7;
        }
        ul, ol {
            margin: 1em 0 1em 2em;
        }
        code, pre {
            background: #f4f7fa;
            border-radius: 5px;
            font-family: "Fira Mono", "Consolas", monospace;
            font-size: 1em;
        }
        pre {
            padding: 1em;
            overflow-x: auto;
        }
        .diagram {
            background: #f9fcff;
            border-radius: 8px;
            margin: 2em auto 1em auto;
            text-align: center;
            padding: 8px 0 0.8em 0;
            max-width: 900px;
        }
        .tip {
            background: #eaffea;
            border-left: 4px solid #4caf50;
            margin: 1.4em 0;
            padding: 1em;
            border-radius: 5px;
        }
        .warn {
            background: #fff5e6;
            border-left: 4px solid #ffc107;
            margin: 1.1em 0;
            padding: 1em;
            border-radius: 5px;
        }
        blockquote {
            border-left: 4px solid #aac6da;
            margin: 1.3em 0;
            padding-left: 1em;
            background: #f7fafd;
            color: #234e70;
            border-radius: 5px;
        }
        nav {
            margin-bottom: 2em;
        }
        nav a {
            color: #234e70;
            margin: 0 12px;
        }
        a {
            color: #234e70;
            text-decoration: underline;
        }
    </style>
</head>
<body>
<header>
    <h1>Ansible Project: Compliance &amp; Patch Management at Scale</h1>
</header>
<main>
<nav>
    <a href="index.html#module15" title="Back to Book Index">&larr; Book Index</a>
</nav>

    <h2>Project Goal & Key Features</h2>
    <ul>
        <li>Regular, automated patching & compliance scanning for 1000+ Linux hosts across datacenters</li>
        <li>Automated remediation, config, and reporting (with audits and notifications)</li>
        <li>Access control, secret management, and approval process via AWX/Tower RBAC</li>
        <li>Flexible: Roles/group_vars support multiple platforms, regions, and business owners</li>
    </ul>

    <div class="diagram">
<svg width="860" height="120">
  <!-- Boxes horizontally: inventory, playbook, roles, audit, AWX UI, notification -->
  <rect x="35" y="55" rx="13" ry="13" width="110" height="38"
        fill="#eaf6fd" stroke="#2288bb" stroke-width="2"/>
  <text x="57" y="78" font-size="14.5" font-family="Segoe UI,Arial" fill="#1875ad" font-weight="bold">
    Inventory
  </text>
  <line x1="145" y1="74" x2="185" y2="74" stroke="#65c36e"
        stroke-width="3" stroke-dasharray="7,7"/>
  <text x="192" y="79" font-size="18" font-family="Segoe UI,Arial" fill="#32a852">&gt;</text>
  <rect x="218" y="55" rx="13" ry="13" width="112" height="38"
        fill="#e3fde5" stroke="#4abb46" stroke-width="2"/>
  <text x="235" y="78" font-size="14.5" font-family="Segoe UI,Arial" fill="#348e37" font-weight="bold">
    Playbooks
  </text>
  <line x1="330" y1="74" x2="370" y2="74" stroke="#ddb054" stroke-width="3" stroke-dasharray="7,7"/>
  <text x="382" y="79" font-size="18" font-family="Segoe UI,Arial" fill="#ddb054">&gt;</text>
  <rect x="410" y="55" rx="13" ry="13" width="90" height="38"
        fill="#fdeacf" stroke="#d2ae48" stroke-width="2"/>
  <text x="427" y="78" font-size="14.5" font-family="Segoe UI,Arial" fill="#be972c" font-weight="bold">
    Roles
  </text>
  <line x1="500" y1="74" x2="540" y2="74" stroke="#aac6da" stroke-width="3" stroke-dasharray="7,7"/>
  <text x="547" y="79" font-size="18" font-family="Segoe UI,Arial" fill="#aac6da">&gt;</text>
  <rect x="580" y="55" rx="13" ry="13" width="85" height="38"
        fill="#ffe6f5" stroke="#d9329e" stroke-width="2"/>
  <text x="597" y="78" font-size="14.5" font-family="Segoe UI,Arial" fill="#d9329e" font-weight="bold">
    Audit
  </text>
  <line x1="665" y1="74" x2="705" y2="74" stroke="#c9d97b" stroke-width="3" stroke-dasharray="7,7"/>
  <text x="712" y="79" font-size="18" font-family="Segoe UI,Arial" fill="#c9d97b">&gt;</text>
  <rect x="745" y="24" rx="13" ry="13" width="95" height="38"
        fill="#f7fed9" stroke="#a0c813" stroke-width="2"/>
  <text x="767" y="47" font-size="14.5" font-family="Segoe UI,Arial" fill="#a0c813" font-weight="bold">
    AWX/Tower
  </text>
  <rect x="745" y="75" rx="13" ry="13" width="95" height="38"
        fill="#e0e8fc" stroke="#3e69b1" stroke-width="2"/>
  <text x="762" y="98" font-size="14.5" font-family="Segoe UI,Arial" fill="#3e69b1" font-weight="bold">
    Notify Ops
  </text>
</svg>
<span style="font-size:1.05em;color:#234e70;">
     Inventories, playbooks, roles & audit steps are orchestrated & controlled by AWX/Tower at scale.
</span>
</div>

    <h2>Project Layout</h2>
    <pre>
patch-management/
  inventories/
    prod.yaml
  group_vars/
    baseline.yaml
    patch.yaml
  roles/
    baseline/
    patcher/
    audit/
  playbooks/
    scan.yml
    apply_patches.yml
    audit_compliance.yml
  .github/
    workflows/checks.yml
  docs/
    </pre>

    <h2>Key Files and Sample Contents</h2>
    <h3>inventories/prod.yaml (YAML inventory for AWX)</h3>
    <pre>
all:
  children:
    webservers:
      hosts:
        web01.example.com:
        web02.example.com:
    databases:
      hosts:
        db01.example.com:
        db02.example.com:
      vars:
        critical: true
    europe:
      hosts:
        web01.example.com:
        db01.example.com:
    usa:
      hosts:
        web02.example.com:
        db02.example.com:
  vars:
    ansible_user: sysmaint
    ansible_port: 22
    ansible_ssh_private_key_file: ~/.ssh/prod.pem
    </pre>

    <h3>group_vars/baseline.yaml</h3>
    <pre>
ntp_servers:
  - time1.google.com
  - 0.pool.ntp.org
firewall_allowed_ports:
  - 22
  - 80
  - 443
admin_users:
  - alice
  - bob
    </pre>
    <h3>group_vars/patch.yaml</h3>
    <pre>
patch_window: "Sun 02:00"
yum_upgrade: true
packages_blacklist: [ "kernel-*" ]
packages_whitelist: [ "openssl", "bash" ]
    </pre>

    <h3>roles/baseline/tasks/main.yml</h3>
    <pre>
- name: Set NTP servers
  ansible.builtin.yum:
    name: chrony
    state: present
  notify: restart chrony

- name: Copy NTP config
  template:
    src: chrony.conf.j2
    dest: /etc/chrony.conf
  notify: restart chrony

- name: Ensure admin users exist
  user:
    name: "{{ item }}"
    groups: wheel
    state: present
  loop: "{{ admin_users }}"

handlers:
  - name: restart chrony
    service:
      name: chronyd
      state: restarted
    </pre>

    <h3>roles/patcher/tasks/main.yml</h3>
    <pre>
- name: Check patch window (skip if not now)
  debug:
    msg: "Skipping patching outside window"
  when: patch_window not in ansible_date_time.date + " " + ansible_date_time.time
  tags: window

- name: Upgrade all packages
  yum:
    name: '*'
    state: latest
    exclude: "{{ packages_blacklist | default([]) }}"
  when: yum_upgrade | bool
  register: patch_result

- name: Install whitelisted packages
  yum:
    name: "{{ packages_whitelist }}"
    state: latest

- name: Reboot if patches require it
  reboot:
    reboot_timeout: 600
  when: patch_result.changed
    </pre>

    <h3>roles/audit/tasks/main.yml</h3>
    <pre>
- name: Gather auditd status
  command: auditctl -s
  register: auditd_status
  changed_when: false

- name: Check for unauthorized users
  shell: "awk -F: '$3 &gt;= 1000 {print $1}' /etc/passwd"
  register: extra_users
  changed_when: false

- name: Output audit report
  debug:
    msg: |
      "Auditd: {{ auditd_status.stdout }}. Extra users: {{ extra_users.stdout_lines }}"
    </pre>

    <h3>playbooks/scan.yml</h3>
    <pre>
- name: Compliance Scan
  hosts: all
  gather_facts: yes
  roles:
    - audit
    </pre>

    <h3>playbooks/apply_patches.yml</h3>
    <pre>
- name: Patch All Servers
  hosts: all
  gather_facts: yes
  roles:
    - patcher
    </pre>

    <h3>playbooks/audit_compliance.yml</h3>
    <pre>
- name: Audit and Baseline
  hosts: all
  gather_facts: yes
  roles:
    - baseline
    - audit
    </pre>

    <h3>.github/workflows/checks.yml (optional: Lint & test on PR)</h3>
    <pre>
name: Lint and Basic Test

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  ansible-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: pip install ansible ansible-lint
      - run: ansible-lint playbooks/
    </pre>

    <h3>docs/README.md (partial)</h3>
    <pre>
# Patch Management & Compliance at Scale

- Scans and patches 1000+ Linux hosts, scheduled via AWX.
- Roles: patcher (OS/PKG updates), baseline (users, ntp, firewall), audit (config checks).
- Smart inventories: group by OS, region, business-criticality.
- Approval and notifications driven by RBAC in AWX/Tower.
- All config and secrets in git, secrets encrypted with Ansible Vault.
    </pre>

    <h2>How the Workflow Connects</h2>
    <ol>
        <li>**Inventories** define hosts by region/role/group for targeting.
        </li>
        <li>**group_vars** load environment/OS/patch/baseline settings and patch window for every group.
        </li>
        <li>**Roles** encapsulate the logic: <b>baseline</b> sets users/firewall/ntp, <b>patcher</b> upgrades and reboots, <b>audit</b> scans and collects compliance info.
        </li>
        <li>**Playbooks** orchestrate role order and logic.
        </li>
        <li>**AWX/Tower** is connected to the repo and inventory (direct or via dynamic source).</li>
        <li>
            On schedule, AWX/Tower <b>runs jobs:</b>
            <ul>
                <li><b>scan.yml</b> — compliance scan, sends output to Slack/email (via notification config).</li>
                <li><b>apply_patches.yml</b> — triggered weekly or on-demand, gated by approval for production group.</li>
                <li><b>audit_compliance.yml</b> — regular audit for continuous compliance, logs/exported to SIEM.</li>
            </ul>
        </li>
        <li>
            **RBAC** in AWX controls who can execute, approve, schedule, or modify each job; audit logs track all activity.
        </li>
        <li>
            **CI/CD** checks playbook syntax/lint on each commit/PR to prevent errors and enforce standards.
        </li>
    </ol>
    <blockquote>
        <b>Result:</b> Teams can patch, audit, and maintain compliance across a massive fleet &mdash; with full history, permissions, scheduling, and safety.
    </blockquote>
    <div class="tip">
        <b>Try it yourself!</b>  
        Clone this project structure, wire to your own AWX/Tower, and scale up efficiently with full transparency and maintainability.
    </div>
</main>
<footer>
    &copy; 2024 Ansible Guidebook &middot; Patch Management Project
</footer>
</body>
</html>